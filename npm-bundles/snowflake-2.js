import t,{useState as e,useCallback as n,useEffect as a,useMemo as i,useRef as o}from"react";function s(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var r,c;var f=s(function(){if(c)return r;c=1;var t="undefined"!=typeof Element,e="function"==typeof Map,n="function"==typeof Set,a="function"==typeof ArrayBuffer&&!!ArrayBuffer.isView;function i(o,s){if(o===s)return!0;if(o&&s&&"object"==typeof o&&"object"==typeof s){if(o.constructor!==s.constructor)return!1;var r,c,f,h;if(Array.isArray(o)){if((r=o.length)!=s.length)return!1;for(c=r;0!==c--;)if(!i(o[c],s[c]))return!1;return!0}if(e&&o instanceof Map&&s instanceof Map){if(o.size!==s.size)return!1;for(h=o.entries();!(c=h.next()).done;)if(!s.has(c.value[0]))return!1;for(h=o.entries();!(c=h.next()).done;)if(!i(c.value[1],s.get(c.value[0])))return!1;return!0}if(n&&o instanceof Set&&s instanceof Set){if(o.size!==s.size)return!1;for(h=o.entries();!(c=h.next()).done;)if(!s.has(c.value[0]))return!1;return!0}if(a&&ArrayBuffer.isView(o)&&ArrayBuffer.isView(s)){if((r=o.length)!=s.length)return!1;for(c=r;0!==c--;)if(o[c]!==s[c])return!1;return!0}if(o.constructor===RegExp)return o.source===s.source&&o.flags===s.flags;if(o.valueOf!==Object.prototype.valueOf&&"function"==typeof o.valueOf&&"function"==typeof s.valueOf)return o.valueOf()===s.valueOf();if(o.toString!==Object.prototype.toString&&"function"==typeof o.toString&&"function"==typeof s.toString)return o.toString()===s.toString();if((r=(f=Object.keys(o)).length)!==Object.keys(s).length)return!1;for(c=r;0!==c--;)if(!Object.prototype.hasOwnProperty.call(s,f[c]))return!1;if(t&&o instanceof Element)return!1;for(c=r;0!==c--;)if(("_owner"!==f[c]&&"__v"!==f[c]&&"__o"!==f[c]||!o.$$typeof)&&!i(o[f[c]],s[f[c]]))return!1;return!0}return o!=o&&s!=s}return r=function(t,e){try{return i(t,e)}catch(t){if((t.message||"").match(/stack|recursion/i))return!1;throw t}}}());function h(t,e){return Number.isInteger(t)&&Number.isInteger(e)?Math.floor(Math.random()*(e-t+1)+t):Math.random()*(e-t)+t}function p(t,e,n){return(1-n)*t+n*e}function u(t){return t?{height:t.offsetHeight,width:t.offsetWidth}:{height:0,width:0}}const d=2*Math.PI,l={color:"#dee4fd",radius:[.5,3],speed:[1,3],wind:[-.5,2],changeFrequency:200,rotationSpeed:[-1,1],opacity:[1,1],enable3DRotation:!1};class g{static createSnowflakes(t,e,n){if(!t)return[];const a=[];for(let i=0;i<e;i++)a.push(new g(t,n));return a}constructor(t,e={}){this.updateConfig(e);const{radius:n,wind:a,speed:i,rotationSpeed:o,opacity:s,enable3DRotation:r}=this.config;this.params={x:h(0,t.offsetWidth),y:h(-t.offsetHeight,0),rotation:h(0,360),radius:h(...n),speed:h(...i),wind:h(...a),rotationSpeed:h(...o),nextSpeed:h(...i),nextWind:h(...a),nextRotationSpeed:h(...o),opacity:h(...s),hasNextOpacity:!1,rotationX:r?h(0,360):0,rotationY:r?h(0,360):0,rotationSpeedX:r?h(-2,2):0,rotationSpeedY:r?h(-2,2):0,nextRotationSpeedX:r?h(-2,2):0,nextRotationSpeedY:r?h(-2,2):0},this.framesSinceLastUpdate=0}selectImage(){var t;this.config.images&&this.config.images.length>0?this.image=(t=this.config.images)[Math.floor(Math.random()*t.length)]:this.image=void 0}updateConfig(t){const e=this.config;this.config={...l,...t},this.config.changeFrequency=h(this.config.changeFrequency,1.5*this.config.changeFrequency),this.params&&!f(this.config.radius,null==e?void 0:e.radius)&&(this.params.radius=h(...this.config.radius)),this.params&&(f(this.config.speed,null==e?void 0:e.speed)||(this.params.nextSpeed=h(...this.config.speed)),f(this.config.wind,null==e?void 0:e.wind)||(this.params.nextWind=h(...this.config.wind)),f(this.config.rotationSpeed,null==e?void 0:e.rotationSpeed)||(this.params.nextRotationSpeed=h(...this.config.rotationSpeed)),this.config.enable3DRotation&&!f(this.config.enable3DRotation,null==e?void 0:e.enable3DRotation)&&(this.params.nextRotationSpeedX=h(-2,2),this.params.nextRotationSpeedY=h(-2,2))),f(this.config.images,null==e?void 0:e.images)||this.selectImage(),(null==e?void 0:e.opacity)&&!f(this.config.opacity,null==e?void 0:e.opacity)&&(this.params.hasNextOpacity=!0)}updateTargetParams(){this.params.nextSpeed=h(...this.config.speed),this.params.nextWind=h(...this.config.wind),this.image&&(this.params.nextRotationSpeed=h(...this.config.rotationSpeed)),this.config.enable3DRotation&&(this.params.nextRotationSpeedX=h(-2,2),this.params.nextRotationSpeedY=h(-2,2))}update(t,e,n=1){const{x:a,y:i,rotation:o,rotationSpeed:s,nextRotationSpeed:r,wind:c,speed:f,nextWind:u,nextSpeed:d,radius:l}=this.params;this.params.x=(a+c*n)%(t+2*l),this.params.x>t+l&&(this.params.x=-l),this.params.y=(i+f*n)%(e+2*l),this.params.y>e+l&&(this.params.hasNextOpacity&&(this.params.opacity=h(...this.config.opacity),this.params.hasNextOpacity=!1),this.params.y=-l),(this.image||this.config.enable3DRotation)&&(this.params.rotation=(o+s)%360),this.config.enable3DRotation&&(this.params.rotationX=(this.params.rotationX+this.params.rotationSpeedX*n)%360,this.params.rotationY=(this.params.rotationY+this.params.rotationSpeedY*n)%360),this.params.speed=p(f,d,.01),this.params.wind=p(c,u,.01),this.params.rotationSpeed=p(s,r,.01),this.config.enable3DRotation&&(this.params.rotationSpeedX=p(this.params.rotationSpeedX,this.params.nextRotationSpeedX,.01),this.params.rotationSpeedY=p(this.params.rotationSpeedY,this.params.nextRotationSpeedY,.01)),this.framesSinceLastUpdate++>this.config.changeFrequency&&(this.updateTargetParams(),this.framesSinceLastUpdate=0)}getImageOffscreenCanvas(t,e){var n,a;if(t instanceof HTMLImageElement&&t.loading)return t;let i=g.offscreenCanvases.get(t);if(i||(i={},g.offscreenCanvases.set(t,i)),!(e in i)){const a=document.createElement("canvas");a.width=e,a.height=e,null===(n=a.getContext("2d"))||void 0===n||n.drawImage(t,0,0,e,e),i[e]=a}return null!==(a=i[e])&&void 0!==a?a:t}apply3DTransform(t,e,n){if(this.config.enable3DRotation){const{rotationX:a,rotationY:i}=this.params,o=this.params.rotation||0,s=a*Math.PI/180,r=i*Math.PI/180,c=o*Math.PI/180,f=Math.cos(s),h=Math.sin(s),p=Math.cos(r),u=Math.sin(r),d=Math.cos(c),l=Math.sin(c),g=d*p,m=d*u*h-l*f,w=d*u*f+l*h,y=l*p;t.setTransform(g,m,w,y,e,n)}else{const a=(this.params.rotation||0)*Math.PI/180,i=Math.cos(a),o=Math.sin(a);t.setTransform(i,o,-o,i,e,n)}}drawCircle(t){t.moveTo(this.params.x,this.params.y),t.arc(this.params.x,this.params.y,this.params.radius,0,d)}drawCircle3D(t,e){const{x:n,y:a,radius:i}=this.params;t.save(),this.config.enable3DRotation?this.apply3DTransform(t,n,a):t.translate(n,a),t.beginPath(),t.arc(0,0,i,0,d),t.fillStyle=e,t.fill(),t.restore()}drawImage(t){const{x:e,y:n,radius:a}=this.params;t.save(),1!==this.params.opacity&&(t.globalAlpha=this.params.opacity),this.apply3DTransform(t,e,n);const i=this.getImageOffscreenCanvas(this.image,a);t.drawImage(i,-a/2,-a/2,a,a),t.restore()}}g.offscreenCanvases=new WeakMap;const m={pointerEvents:"none",backgroundColor:"transparent",position:"absolute",top:0,left:0,width:"100%",height:"100%"},w=1e3/60;var y,v,S=function(t,e,n,a){if("a"===n&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?a:"a"===n?a.call(t):a?a.value:e.get(t)},x=function(t,e,n,a,i){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(t,n):i?i.value=n:e.set(t,n),n};class b{get ctx(){return S(this,y,"f")}get canvas(){return S(this,v,"f")}set canvas(t){x(this,v,t,"f"),x(this,y,t.getContext("2d"),"f")}constructor(t,e){this.lastUpdate=Date.now(),this.snowflakes=[],y.set(this,void 0),v.set(this,void 0),x(this,v,t,"f"),x(this,y,t.getContext("2d"),"f"),this.config={snowflakeCount:150,...l,...e},this.snowflakes=[],this.snowflakes=g.createSnowflakes(t,e.snowflakeCount||150,e),this.play()}updateConfig(t){this.config={...this.config,...t};const e=this.config.snowflakeCount-this.snowflakes.length;e>0&&(this.snowflakes=[...this.snowflakes,...g.createSnowflakes(this.canvas,e,t)]),e<0&&(this.snowflakes=this.snowflakes.slice(0,this.config.snowflakeCount));for(const t of this.snowflakes)t.updateConfig(this.config)}render(t=1){const{ctx:e,canvas:n,snowflakes:a}=this;if(!e||!n)return;const{offsetWidth:i,offsetHeight:o}=n;for(const e of a)e.update(i,o,t);if(e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,i,o),this.config.images&&this.config.images.length>0)for(const t of a)t.drawImage(e);else if(this.config.enable3DRotation)for(const t of a)t.drawCircle3D(e,this.config.color);else{e.beginPath();for(const t of a)t.drawCircle(e);e.fillStyle=this.config.color,e.fill()}}loop(){const t=Date.now(),e=Date.now()-this.lastUpdate;this.lastUpdate=t;const n=e/w;this.render(n),this.animationFrame=requestAnimationFrame(()=>this.loop())}play(){this.loop()}pause(){this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0)}}y=new WeakMap,v=new WeakMap;function R(t){const[n,i]=e(t);return function(t,e){const n=o(e);f(e,n.current)||(n.current=e),a(t,n.current)}(()=>i(t),[t]),n}const C=({color:s=l.color,changeFrequency:r=l.changeFrequency,radius:c=l.radius,speed:f=l.speed,wind:h=l.wind,rotationSpeed:p=l.rotationSpeed,opacity:d=l.opacity,snowflakeCount:g=150,images:w,enable3DRotation:y=l.enable3DRotation,style:v}={})=>{const S=i(()=>({...m,...x||{}}),[x=v]);var x;const C=o(null),k=(t=>{const[i,o]=e(u(t.current)),s=n(()=>{t.current&&o(u(t.current))},[t]);return a(()=>{const{ResizeObserver:e}=window;if(t.current){if(s(),"function"==typeof e){const n=new e(s);return n.observe(t.current),()=>n.disconnect()}return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)}},[t,s]),i})(C),M=R({color:s,changeFrequency:r,radius:c,speed:f,wind:h,rotationSpeed:p,images:w,snowflakeCount:g,opacity:d,enable3DRotation:y}),D=o(M),O=o();return a(()=>(!O.current&&C.current&&(O.current=new b(C.current,D.current)),()=>{var t;null===(t=O.current)||void 0===t||t.pause(),O.current=void 0}),[]),a(()=>{O.current&&O.current.updateConfig(M)},[M]),t.createElement("canvas",{ref:C,height:k.height,width:k.width,style:S,"data-testid":"SnowfallCanvas"})};export{C as Snowfall,C as default};
