import t,{useState as e,useCallback as i,useEffect as a,useMemo as n,useRef as s}from"react";function o(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var r,h;var f=o(function(){if(h)return r;h=1;var t="undefined"!=typeof Element,e="function"==typeof Map,i="function"==typeof Set,a="function"==typeof ArrayBuffer&&!!ArrayBuffer.isView;function n(s,o){if(s===o)return!0;if(s&&o&&"object"==typeof s&&"object"==typeof o){if(s.constructor!==o.constructor)return!1;var r,h,f,c;if(Array.isArray(s)){if((r=s.length)!=o.length)return!1;for(h=r;0!==h--;)if(!n(s[h],o[h]))return!1;return!0}if(e&&s instanceof Map&&o instanceof Map){if(s.size!==o.size)return!1;for(c=s.entries();!(h=c.next()).done;)if(!o.has(h.value[0]))return!1;for(c=s.entries();!(h=c.next()).done;)if(!n(h.value[1],o.get(h.value[0])))return!1;return!0}if(i&&s instanceof Set&&o instanceof Set){if(s.size!==o.size)return!1;for(c=s.entries();!(h=c.next()).done;)if(!o.has(h.value[0]))return!1;return!0}if(a&&ArrayBuffer.isView(s)&&ArrayBuffer.isView(o)){if((r=s.length)!=o.length)return!1;for(h=r;0!==h--;)if(s[h]!==o[h])return!1;return!0}if(s.constructor===RegExp)return s.source===o.source&&s.flags===o.flags;if(s.valueOf!==Object.prototype.valueOf&&"function"==typeof s.valueOf&&"function"==typeof o.valueOf)return s.valueOf()===o.valueOf();if(s.toString!==Object.prototype.toString&&"function"==typeof s.toString&&"function"==typeof o.toString)return s.toString()===o.toString();if((r=(f=Object.keys(s)).length)!==Object.keys(o).length)return!1;for(h=r;0!==h--;)if(!Object.prototype.hasOwnProperty.call(o,f[h]))return!1;if(t&&s instanceof Element)return!1;for(h=r;0!==h--;)if(("_owner"!==f[h]&&"__v"!==f[h]&&"__o"!==f[h]||!s.$$typeof)&&!n(s[f[h]],o[f[h]]))return!1;return!0}return s!=s&&o!=o}return r=function(t,e){try{return n(t,e)}catch(t){if((t.message||"").match(/stack|recursion/i))return!1;throw t}}}());function c(t,e){return Number.isInteger(t)&&Number.isInteger(e)?Math.floor(Math.random()*(e-t+1)+t):Math.random()*(e-t)+t}function p(t,e,i){return(1-i)*t+i*e}function d(t){return t?{height:t.offsetHeight,width:t.offsetWidth}:{height:0,width:0}}const u=2*Math.PI,l={pointerEvents:"none",backgroundColor:"transparent",position:"absolute",top:0,left:0,width:"100%",height:"100%"},m=1e3/60,g={color:"#dee4fd",radius:[.5,3],speed:[1,3],wind:[-.5,2],changeFrequency:200,rotationSpeed:[-1,1],opacity:[1,1],enable3DRotation:!1,transitionTime:0};class w{static createSnowflakes(t,e,i){if(!t)return[];const a=[];for(let n=0;n<e;n++)a.push(new w(t,i));return a}constructor(t,e={}){this.updateConfig(e);const{radius:i,wind:a,speed:n,rotationSpeed:s,opacity:o,enable3DRotation:r}=this.config;this.params={x:c(0,t.offsetWidth),y:c(-t.offsetHeight,0),rotation:c(0,360),radius:c(...i),speed:c(...n),wind:c(...a),rotationSpeed:c(...s),nextSpeed:c(...n),nextWind:c(...a),nextRotationSpeed:c(...s),opacity:c(...o),hasNextOpacity:!1,rotationX:r?c(0,360):0,rotationY:r?c(0,360):0,rotationSpeedX:r?c(-2,2):0,rotationSpeedY:r?c(-2,2):0,nextRotationSpeedX:r?c(-2,2):0,nextRotationSpeedY:r?c(-2,2):0,isRemoving:!1},this.framesSinceLastUpdate=0}selectImage(){var t;this.config.images&&this.config.images.length>0?this.image=(t=this.config.images)[Math.floor(Math.random()*t.length)]:this.image=void 0}updateConfig(t){const e=this.config;this.config={...g,...t},this.config.changeFrequency=c(this.config.changeFrequency,1.5*this.config.changeFrequency),this.params&&!f(this.config.radius,null==e?void 0:e.radius)&&(this.params.radius=c(...this.config.radius)),this.params&&(f(this.config.speed,null==e?void 0:e.speed)||(this.params.nextSpeed=c(...this.config.speed),0===this.config.transitionTime&&(this.params.speed=this.params.nextSpeed)),f(this.config.wind,null==e?void 0:e.wind)||(this.params.nextWind=c(...this.config.wind),0===this.config.transitionTime&&(this.params.wind=this.params.nextWind)),f(this.config.rotationSpeed,null==e?void 0:e.rotationSpeed)||(this.params.nextRotationSpeed=c(...this.config.rotationSpeed),0===this.config.transitionTime&&(this.params.rotationSpeed=this.params.nextRotationSpeed)),this.config.enable3DRotation&&!f(this.config.enable3DRotation,null==e?void 0:e.enable3DRotation)&&(this.params.nextRotationSpeedX=c(-2,2),this.params.nextRotationSpeedY=c(-2,2),0===this.config.transitionTime&&(this.params.rotationSpeedX=this.params.nextRotationSpeedX,this.params.rotationSpeedY=this.params.nextRotationSpeedY))),f(this.config.images,null==e?void 0:e.images)||this.selectImage(),(null==e?void 0:e.opacity)&&!f(this.config.opacity,null==e?void 0:e.opacity)&&(this.params.hasNextOpacity=!0)}markForRemoval(){this.params.isRemoving||(this.params.isRemoving=!0)}shouldRemove(t,e){return!!this.params.isRemoving&&this.params.y>e+this.params.radius}updateTargetParams(){this.params.nextSpeed=c(...this.config.speed),this.params.nextWind=c(...this.config.wind),this.image&&(this.params.nextRotationSpeed=c(...this.config.rotationSpeed)),this.config.enable3DRotation&&(this.params.nextRotationSpeedX=c(-2,2),this.params.nextRotationSpeedY=c(-2,2))}update(t,e,i=1){const{x:a,y:n,rotation:s,rotationSpeed:o,nextRotationSpeed:r,wind:h,speed:f,nextWind:d,nextSpeed:u,radius:l}=this.params;this.params.x=(a+h*i)%(t+2*l),this.params.x>t+l&&(this.params.x=-l),this.params.y=(n+f*i)%(e+2*l),this.params.y>e+l&&(this.params.hasNextOpacity&&(this.params.opacity=c(...this.config.opacity),this.params.hasNextOpacity=!1),this.params.y=-l),(this.image||this.config.enable3DRotation)&&(this.params.rotation=(s+o)%360),this.config.enable3DRotation&&(this.params.rotationX=(this.params.rotationX+this.params.rotationSpeedX*i)%360,this.params.rotationY=(this.params.rotationY+this.params.rotationSpeedY*i)%360);const g=m,w=this.config.transitionTime>0?this.config.transitionTime/g:1,y=this.config.transitionTime>0?Math.min(i/w,1):1;this.params.speed=p(f,u,y),this.params.wind=p(h,d,y),this.params.rotationSpeed=p(o,r,y),this.config.enable3DRotation&&(this.params.rotationSpeedX=p(this.params.rotationSpeedX,this.params.nextRotationSpeedX,y),this.params.rotationSpeedY=p(this.params.rotationSpeedY,this.params.nextRotationSpeedY,y)),this.framesSinceLastUpdate++>this.config.changeFrequency&&(this.updateTargetParams(),this.framesSinceLastUpdate=0)}getImageOffscreenCanvas(t,e){var i,a;if(t instanceof HTMLImageElement&&t.loading)return t;let n=w.offscreenCanvases.get(t);if(n||(n={},w.offscreenCanvases.set(t,n)),!(e in n)){const a=document.createElement("canvas");a.width=e,a.height=e,null===(i=a.getContext("2d"))||void 0===i||i.drawImage(t,0,0,e,e),n[e]=a}return null!==(a=n[e])&&void 0!==a?a:t}apply3DTransform(t,e,i){if(this.config.enable3DRotation){const{rotationX:a,rotationY:n}=this.params,s=this.params.rotation||0,o=a*Math.PI/180,r=n*Math.PI/180,h=s*Math.PI/180,f=Math.cos(o),c=Math.sin(o),p=Math.cos(r),d=Math.sin(r),u=Math.cos(h),l=Math.sin(h),m=u*p,g=u*d*c-l*f,w=u*d*f+l*c,y=l*p;t.setTransform(m,g,w,y,e,i)}else{const a=(this.params.rotation||0)*Math.PI/180,n=Math.cos(a),s=Math.sin(a);t.setTransform(n,s,-s,n,e,i)}}drawCircle(t){t.moveTo(this.params.x,this.params.y),t.arc(this.params.x,this.params.y,this.params.radius,0,u)}drawCircle3D(t,e){const{x:i,y:a,radius:n}=this.params;t.save(),this.config.enable3DRotation?this.apply3DTransform(t,i,a):t.translate(i,a),t.beginPath(),t.arc(0,0,n,0,u),t.fillStyle=e,t.fill(),t.restore()}drawImage(t){const{x:e,y:i,radius:a}=this.params;t.save(),1!==this.params.opacity&&(t.globalAlpha=this.params.opacity),this.apply3DTransform(t,e,i);const n=this.getImageOffscreenCanvas(this.image,a);t.drawImage(n,-a/2,-a/2,a,a),t.restore()}}w.offscreenCanvases=new WeakMap;var y,v,S=function(t,e,i,a){if("a"===i&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?a:"a"===i?a.call(t):a?a.value:e.get(t)},x=function(t,e,i,a,n){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?n.call(t,i):n?n.value=i:e.set(t,i),i};class R{get ctx(){return S(this,y,"f")}get canvas(){return S(this,v,"f")}set canvas(t){x(this,v,t,"f"),x(this,y,t.getContext("2d"),"f")}constructor(t,e){this.lastUpdate=Date.now(),this.snowflakes=[],y.set(this,void 0),v.set(this,void 0),x(this,v,t,"f"),x(this,y,t.getContext("2d"),"f"),this.config={snowflakeCount:150,...g,...e},this.snowflakes=[],this.snowflakes=w.createSnowflakes(t,e.snowflakeCount||150,e),this.play()}updateConfig(t){this.config={...this.config,...t};const e=this.config.snowflakeCount-this.snowflakes.length;if(e>0)this.snowflakes=[...this.snowflakes,...w.createSnowflakes(this.canvas,e,t)];else if(e<0){const t=Math.abs(e);let i=0;for(let e=this.snowflakes.length-1;e>=0&&i<t;e--)this.snowflakes[e].params.isRemoving||(this.snowflakes[e].markForRemoval(),i++)}for(const t of this.snowflakes)t.updateConfig(this.config)}render(t=1){const{ctx:e,canvas:i,snowflakes:a}=this;if(!e||!i)return;const{offsetWidth:n,offsetHeight:s}=i;for(const e of a)e.update(n,s,t);if(this.snowflakes=this.snowflakes.filter(t=>!t.shouldRemove(n,s)),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,n,s),this.config.images&&this.config.images.length>0)for(const t of a)t.drawImage(e);else if(this.config.enable3DRotation)for(const t of a)t.drawCircle3D(e,this.config.color);else{e.beginPath();for(const t of a)t.drawCircle(e);e.fillStyle=this.config.color,e.fill()}}loop(){const t=Date.now(),e=Date.now()-this.lastUpdate;this.lastUpdate=t;const i=e/m;this.render(i),this.animationFrame=requestAnimationFrame(()=>this.loop())}play(){this.loop()}pause(){this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0)}}y=new WeakMap,v=new WeakMap;function b(t){const[i,n]=e(t);return function(t,e){const i=s(e);f(e,i.current)||(i.current=e),a(t,i.current)}(()=>n(t),[t]),i}const k=({color:o=g.color,changeFrequency:r=g.changeFrequency,radius:h=g.radius,speed:f=g.speed,wind:c=g.wind,rotationSpeed:p=g.rotationSpeed,opacity:u=g.opacity,snowflakeCount:m=150,images:w,enable3DRotation:y=g.enable3DRotation,transitionTime:v=g.transitionTime,style:S}={})=>{const x=n(()=>({...l,...k||{}}),[k=S]);var k;const M=s(null),C=(t=>{const[n,s]=e(d(t.current)),o=i(()=>{t.current&&s(d(t.current))},[t]);return a(()=>{const{ResizeObserver:e}=window;if(t.current){if(o(),"function"==typeof e){const i=new e(o);return i.observe(t.current),()=>i.disconnect()}return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)}},[t,o]),n})(M),T=b({color:o,changeFrequency:r,radius:h,speed:f,wind:c,rotationSpeed:p,images:w,snowflakeCount:m,opacity:u,enable3DRotation:y,transitionTime:v}),D=s(T),O=s();return a(()=>(!O.current&&M.current&&(O.current=new R(M.current,D.current)),()=>{var t;null===(t=O.current)||void 0===t||t.pause(),O.current=void 0}),[]),a(()=>{O.current&&O.current.updateConfig(T)},[T]),t.createElement("canvas",{ref:M,height:C.height,width:C.width,style:x,"data-testid":"SnowfallCanvas"})};export{k as Snowfall,k as default};
