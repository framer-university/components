import t,{useState as e,useCallback as i,useEffect as n,useMemo as a,useRef as s}from"react";function r(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var o,h;var c=r(function(){if(h)return o;h=1;var t="undefined"!=typeof Element,e="function"==typeof Map,i="function"==typeof Set,n="function"==typeof ArrayBuffer&&!!ArrayBuffer.isView;function a(s,r){if(s===r)return!0;if(s&&r&&"object"==typeof s&&"object"==typeof r){if(s.constructor!==r.constructor)return!1;var o,h,c,f;if(Array.isArray(s)){if((o=s.length)!=r.length)return!1;for(h=o;0!==h--;)if(!a(s[h],r[h]))return!1;return!0}if(e&&s instanceof Map&&r instanceof Map){if(s.size!==r.size)return!1;for(f=s.entries();!(h=f.next()).done;)if(!r.has(h.value[0]))return!1;for(f=s.entries();!(h=f.next()).done;)if(!a(h.value[1],r.get(h.value[0])))return!1;return!0}if(i&&s instanceof Set&&r instanceof Set){if(s.size!==r.size)return!1;for(f=s.entries();!(h=f.next()).done;)if(!r.has(h.value[0]))return!1;return!0}if(n&&ArrayBuffer.isView(s)&&ArrayBuffer.isView(r)){if((o=s.length)!=r.length)return!1;for(h=o;0!==h--;)if(s[h]!==r[h])return!1;return!0}if(s.constructor===RegExp)return s.source===r.source&&s.flags===r.flags;if(s.valueOf!==Object.prototype.valueOf&&"function"==typeof s.valueOf&&"function"==typeof r.valueOf)return s.valueOf()===r.valueOf();if(s.toString!==Object.prototype.toString&&"function"==typeof s.toString&&"function"==typeof r.toString)return s.toString()===r.toString();if((o=(c=Object.keys(s)).length)!==Object.keys(r).length)return!1;for(h=o;0!==h--;)if(!Object.prototype.hasOwnProperty.call(r,c[h]))return!1;if(t&&s instanceof Element)return!1;for(h=o;0!==h--;)if(("_owner"!==c[h]&&"__v"!==c[h]&&"__o"!==c[h]||!s.$$typeof)&&!a(s[c[h]],r[c[h]]))return!1;return!0}return s!=s&&r!=r}return o=function(t,e){try{return a(t,e)}catch(t){if((t.message||"").match(/stack|recursion/i))return!1;throw t}}}());function f(t,e){return Number.isInteger(t)&&Number.isInteger(e)?Math.floor(Math.random()*(e-t+1)+t):Math.random()*(e-t)+t}function p(t,e,i){return(1-i)*t+i*e}function u(t){return t?{height:t.offsetHeight,width:t.offsetWidth}:{height:0,width:0}}const l=2*Math.PI;function m(t){if(!t)return{r:222,g:228,b:253};const e=t.trim(),i=e.match(/rgba?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)\s*(?:,\s*([\d.]+)\s*)?\)/i);if(i)return{r:Math.max(0,Math.min(255,parseFloat(i[1]))),g:Math.max(0,Math.min(255,parseFloat(i[2]))),b:Math.max(0,Math.min(255,parseFloat(i[3])))};const n=e.replace(/^#/,"");return 6===n.length?{r:parseInt(n.slice(0,2),16),g:parseInt(n.slice(2,4),16),b:parseInt(n.slice(4,6),16)}:3===n.length?{r:parseInt(n[0]+n[0],16),g:parseInt(n[1]+n[1],16),b:parseInt(n[2]+n[2],16)}:{r:222,g:228,b:253}}function d(t,e,i){const n=m(t),a=m(e);return function(t,e,i){const n=t=>{const e=Math.round(Math.max(0,Math.min(255,t))).toString(16);return 1===e.length?"0"+e:e};return"#"+n(t)+n(e)+n(i)}(p(n.r,a.r,i),p(n.g,a.g,i),p(n.b,a.b,i))}const g={pointerEvents:"none",backgroundColor:"transparent",position:"absolute",top:0,left:0,width:"100%",height:"100%"},w=1e3/60,y={color:"#dee4fd",radius:[.5,3],speed:[1,3],wind:[-.5,2],changeFrequency:200,rotationSpeed:[-1,1],opacity:[1,1],enable3DRotation:!1,transitionTime:0,direction:"down"};class v{static createSnowflakes(t,e,i){if(!t)return[];const n=[];for(let a=0;a<e;a++)n.push(new v(t,i));return n}constructor(t,e={}){this.updateConfig(e);const{radius:i,wind:n,speed:a,rotationSpeed:s,opacity:r,enable3DRotation:o,direction:h}=this.config,c=f(...i),p=f(...r),u=f(...n);let l;const m=t.offsetWidth,d=(n[0]+n[1])/2;let g;l=d<-.5?f(.8*m,m):f(0,d>.5?.2*m:m),g="up"===h?f(t.offsetHeight,2*t.offsetHeight):f(-t.offsetHeight,0);const w="up"===h?-f(...a):f(...a);this.params={x:l,y:g,rotation:f(0,360),radius:c,nextRadius:c,speed:w,wind:u,rotationSpeed:f(...s),nextSpeed:w,nextWind:f(...n),nextRotationSpeed:f(...s),opacity:p,nextOpacity:p,rotationX:o?f(0,360):0,rotationY:o?f(0,360):0,rotationSpeedX:o?f(-2,2):0,rotationSpeedY:o?f(-2,2):0,nextRotationSpeedX:o?f(-2,2):0,nextRotationSpeedY:o?f(-2,2):0,currentColor:this.config.color,nextColor:this.config.color,isRemoving:!1},this.framesSinceLastUpdate=0}selectImage(){var t;this.config.images&&this.config.images.length>0?this.image=(t=this.config.images)[Math.floor(Math.random()*t.length)]:this.image=void 0}updateConfig(t){const e=this.config;this.config={...y,...t},this.config.changeFrequency=f(this.config.changeFrequency,1.5*this.config.changeFrequency),this.params&&(c(this.config.speed,null==e?void 0:e.speed)&&c(this.config.direction,null==e?void 0:e.direction)||(this.params.nextSpeed="up"===this.config.direction?-f(...this.config.speed):f(...this.config.speed),0===this.config.transitionTime&&(this.params.speed=this.params.nextSpeed)),c(this.config.wind,null==e?void 0:e.wind)||(this.params.nextWind=f(...this.config.wind),0===this.config.transitionTime&&(this.params.wind=this.params.nextWind)),c(this.config.rotationSpeed,null==e?void 0:e.rotationSpeed)||(this.params.nextRotationSpeed=f(...this.config.rotationSpeed),0===this.config.transitionTime&&(this.params.rotationSpeed=this.params.nextRotationSpeed)),this.config.enable3DRotation&&!c(this.config.enable3DRotation,null==e?void 0:e.enable3DRotation)&&(this.params.nextRotationSpeedX=f(-2,2),this.params.nextRotationSpeedY=f(-2,2),0===this.config.transitionTime&&(this.params.rotationSpeedX=this.params.nextRotationSpeedX,this.params.rotationSpeedY=this.params.nextRotationSpeedY)),c(this.config.color,null==e?void 0:e.color)||(this.params.nextColor=this.config.color,0===this.config.transitionTime&&(this.params.currentColor=this.params.nextColor)),c(this.config.radius,null==e?void 0:e.radius)||(this.params.nextRadius=f(...this.config.radius),0===this.config.transitionTime&&(this.params.radius=this.params.nextRadius)),c(this.config.opacity,null==e?void 0:e.opacity)||(this.params.nextOpacity=f(...this.config.opacity),0===this.config.transitionTime&&(this.params.opacity=this.params.nextOpacity))),c(this.config.images,null==e?void 0:e.images)||this.selectImage()}markForRemoval(){this.params.isRemoving||(this.params.isRemoving=!0)}shouldRemove(t,e){return!!this.params.isRemoving&&("up"===this.config.direction?this.params.y<-this.params.radius:this.params.y>e+this.params.radius)}updateTargetParams(){this.params.nextSpeed="up"===this.config.direction?-f(...this.config.speed):f(...this.config.speed),this.params.nextWind=f(...this.config.wind),this.image&&(this.params.nextRotationSpeed=f(...this.config.rotationSpeed)),this.config.enable3DRotation&&(this.params.nextRotationSpeedX=f(-2,2),this.params.nextRotationSpeedY=f(-2,2))}update(t,e,i=1){const{x:n,y:a,rotation:s,rotationSpeed:r,nextRotationSpeed:o,wind:h,speed:c,nextWind:f,nextSpeed:u,radius:l}=this.params;this.params.x=n+h*i,h<0?this.params.x<-l&&(this.params.x=t+l):(h>0||(this.params.x=(this.params.x%(t+2*l)+(t+2*l))%(t+2*l)),this.params.x>t+l&&(this.params.x=-l)),this.params.y=a+c*i,this.params.isRemoving||("up"===this.config.direction?(this.params.y=(this.params.y%(e+2*l)+(e+2*l))%(e+2*l),this.params.y<-l&&(this.params.y=e+l)):(this.params.y=this.params.y%(e+2*l),this.params.y>e+l&&(this.params.y=-l))),(this.image||this.config.enable3DRotation)&&(this.params.rotation=(s+r)%360),this.config.enable3DRotation&&(this.params.rotationX=(this.params.rotationX+this.params.rotationSpeedX*i)%360,this.params.rotationY=(this.params.rotationY+this.params.rotationSpeedY*i)%360);const m=w,g=this.config.transitionTime>0?this.config.transitionTime/m:1,y=this.config.transitionTime>0?Math.min(i/g,1):1;this.params.speed=p(c,u,y),this.params.wind=p(h,f,y),this.params.rotationSpeed=p(r,o,y),this.params.radius=p(this.params.radius,this.params.nextRadius,y),this.params.opacity=p(this.params.opacity,this.params.nextOpacity,y),this.params.currentColor!==this.params.nextColor&&(this.params.currentColor=d(this.params.currentColor,this.params.nextColor,y)),this.config.enable3DRotation&&(this.params.rotationSpeedX=p(this.params.rotationSpeedX,this.params.nextRotationSpeedX,y),this.params.rotationSpeedY=p(this.params.rotationSpeedY,this.params.nextRotationSpeedY,y)),this.framesSinceLastUpdate++>this.config.changeFrequency&&(this.updateTargetParams(),this.framesSinceLastUpdate=0)}getImageOffscreenCanvas(t,e){var i,n;if(t instanceof HTMLImageElement&&t.loading)return t;let a=v.offscreenCanvases.get(t);if(a||(a={},v.offscreenCanvases.set(t,a)),!(e in a)){const n=document.createElement("canvas");n.width=e,n.height=e,null===(i=n.getContext("2d"))||void 0===i||i.drawImage(t,0,0,e,e),a[e]=n}return null!==(n=a[e])&&void 0!==n?n:t}apply3DTransform(t,e,i){if(this.config.enable3DRotation){const{rotationX:n,rotationY:a}=this.params,s=this.params.rotation||0,r=n*Math.PI/180,o=a*Math.PI/180,h=s*Math.PI/180,c=Math.cos(r),f=Math.sin(r),p=Math.cos(o),u=Math.sin(o),l=Math.cos(h),m=Math.sin(h),d=l*p,g=l*u*f-m*c,w=l*u*c+m*f,y=m*p;t.setTransform(d,g,w,y,e,i)}else{const n=(this.params.rotation||0)*Math.PI/180,a=Math.cos(n),s=Math.sin(n);t.setTransform(a,s,-s,a,e,i)}}drawCircleWithOpacity(t,e){const{x:i,y:n,radius:a,opacity:s}=this.params;t.save(),t.globalAlpha=s,t.beginPath(),t.moveTo(i,n),t.arc(i,n,a,0,l),t.fillStyle=e,t.fill(),t.restore()}drawCircle3D(t,e){const{x:i,y:n,radius:a,opacity:s}=this.params;t.save(),t.globalAlpha=s,this.config.enable3DRotation?this.apply3DTransform(t,i,n):t.translate(i,n),t.beginPath(),t.arc(0,0,a,0,l),t.fillStyle=e,t.fill(),t.restore()}drawImage(t){const{x:e,y:i,radius:n,opacity:a}=this.params;t.save(),t.globalAlpha=a,this.apply3DTransform(t,e,i);const s=this.getImageOffscreenCanvas(this.image,n);t.drawImage(s,-n/2,-n/2,n,n),t.restore()}}v.offscreenCanvases=new WeakMap;var x,S,R=function(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)},b=function(t,e,i,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(t,i):a?a.value=i:e.set(t,i),i};class k{get ctx(){return R(this,x,"f")}get canvas(){return R(this,S,"f")}set canvas(t){b(this,S,t,"f"),b(this,x,t.getContext("2d"),"f")}constructor(t,e){this.lastUpdate=Date.now(),this.snowflakes=[],this.shouldAnimate=!0,this.animationFrame=void 0,x.set(this,void 0),S.set(this,void 0),b(this,S,t,"f"),b(this,x,t.getContext("2d"),"f"),this.config={snowflakeCount:150,...y,...e},this.snowflakes=[],this.snowflakes=v.createSnowflakes(t,e.snowflakeCount||150,e),this.play()}updateConfig(t){this.config={...this.config,...t};const e=this.snowflakes.filter(t=>!t.params.isRemoving),i=this.snowflakes.filter(t=>t.params.isRemoving),n=this.config.snowflakeCount-e.length;if(n>0){const e=Math.min(n,i.length);let a=0;for(let t=0;t<this.snowflakes.length&&a<e;t++)this.snowflakes[t].params.isRemoving&&(this.snowflakes[t].params.isRemoving=!1,a++);const s=n-a;s>0&&(this.snowflakes=[...this.snowflakes,...v.createSnowflakes(this.canvas,s,t)])}else if(n<0){const t=Math.abs(n);let e=0;for(let i=this.snowflakes.length-1;i>=0&&e<t;i--)this.snowflakes[i].params.isRemoving||(this.snowflakes[i].markForRemoval(),e++)}for(const t of this.snowflakes)t.updateConfig(this.config);const{offsetWidth:a,offsetHeight:s}=this.canvas;this.snowflakes=this.snowflakes.filter(t=>!t.shouldRemove(a,s))}render(t=1){const{ctx:e,canvas:i,snowflakes:n}=this;if(!e||!i)return;const{offsetWidth:a,offsetHeight:s}=i;for(const e of n)e.update(a,s,t);this.snowflakes=this.snowflakes.filter(t=>!t.shouldRemove(a,s)),this.renderFrame()}renderFrame(){const{ctx:t,canvas:e}=this;if(!t||!e)return;const{offsetWidth:i,offsetHeight:n}=e;this.snowflakes=this.snowflakes.filter(t=>!t.shouldRemove(i,n));const a=this.snowflakes;if(t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,i,n),this.config.images&&this.config.images.length>0)for(const e of a)e.drawImage(t);else for(const e of a)this.config.enable3DRotation?e.drawCircle3D(t,e.params.currentColor):e.drawCircleWithOpacity(t,e.params.currentColor)}loop(){if(!this.shouldAnimate)return void(this.animationFrame=void 0);const t=Date.now(),e=Date.now()-this.lastUpdate;this.lastUpdate=t;const i=e/w;this.render(i),this.animationFrame=requestAnimationFrame(()=>this.loop())}play(){this.shouldAnimate=!0,this.animationFrame||this.loop()}pause(){this.shouldAnimate=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0)}}x=new WeakMap,S=new WeakMap;function C(t){const[i,a]=e(t);return function(t,e){const i=s(e);c(e,i.current)||(i.current=e),n(t,i.current)}(()=>a(t),[t]),i}const M=({color:r=y.color,changeFrequency:o=y.changeFrequency,radius:h=y.radius,speed:c=y.speed,wind:f=y.wind,rotationSpeed:p=y.rotationSpeed,opacity:l=y.opacity,snowflakeCount:m=150,images:d,enable3DRotation:w=y.enable3DRotation,transitionTime:v=y.transitionTime,direction:x=y.direction,paused:S=!1,style:R}={})=>{const b=a(()=>({...g,...M||{}}),[M=R]);var M;const T=s(null),F=(t=>{const[a,s]=e(u(t.current)),r=i(()=>{t.current&&s(u(t.current))},[t]);return n(()=>{const{ResizeObserver:e}=window;if(t.current){if(r(),"function"==typeof e){const i=new e(r);return i.observe(t.current),()=>i.disconnect()}return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)}},[t,r]),a})(T),D=C({color:r,changeFrequency:o,radius:h,speed:c,wind:f,rotationSpeed:p,images:d,snowflakeCount:m,opacity:l,enable3DRotation:w,transitionTime:v,direction:x}),O=s(D),I=s(),A=s(S);return n(()=>(!I.current&&T.current&&(I.current=new k(T.current,O.current),S&&(A.current=!0,I.current.pause(),setTimeout(()=>{if(I.current&&A.current){for(let t=0;t<180;t++)I.current.render(1);I.current.renderFrame()}},100))),()=>{var t;null===(t=I.current)||void 0===t||t.pause(),I.current=void 0}),[]),n(()=>{I.current&&(I.current.updateConfig(D),A.current&&setTimeout(()=>{I.current&&A.current&&I.current.renderFrame()},0))},[D]),n(()=>{I.current&&(A.current=S,S?(I.current.pause(),setTimeout(()=>{I.current&&A.current&&I.current.renderFrame()},0)):I.current.play())},[S]),t.createElement("canvas",{ref:T,height:F.height,width:F.width,style:b,"data-testid":"SnowfallCanvas"})};export{M as Snowfall,M as default};
